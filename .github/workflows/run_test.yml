name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ${{ matrix.os.name }}-${{ matrix.os.version }}

    strategy:
      fail-fast: false

      matrix:
        os:
          - name: ubuntu
            version: 24.04
        build_type: [Release, Debug]
        cpp_ver: [20, 23, 26]
        compiler:
          - vendor: GNU
            version: 13
            executable: g++-13
          - vendor: GNU
            version: 14
            executable: g++-14
          - vendor: LLVM
            version: 19
            executable: clang++-19
          - vendor: LLVM
            version: 20
            executable: clang++-20
        exclude:
          - compiler:
              vendor: GNU
              version: 13
            cpp_ver: 26

    steps:
      - uses: actions/checkout@v4

      - name: Setup Clang
        if: matrix.compiler.vendor == 'LLVM'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x ./llvm.sh
          sudo ./llvm.sh ${{ matrix.compiler.version }} all

      - name: Setup GCC
        if: matrix.compiler.vendor == 'GNU'
        run: sudo apt update && sudo apt install -y g++-${{ matrix.compiler.version }}

      - name: Install Deps
        if: matrix.os.name == 'ubuntu'
        run: sudo apt update && sudo apt install libboost-test-dev

      - name: Configure CMake
        run: >
          cmake -B ${{ github.workspace }}/build
          -DCMAKE_CXX_COMPILER=${{ matrix.compiler.executable }}
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          -DCMAKE_CXX_STANDARD=${{ matrix.cpp_ver }}
          -S ${{ github.workspace }}

      - name: Build
        run: cmake --build ${{ github.workspace }}/build --config ${{ matrix.build_type }} --target yk_util_test

      - name: Test
        working-directory: ${{ github.workspace }}/build/test
        run: ./yk_util_test --report_level=short
